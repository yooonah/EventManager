<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      @font-face {
        font-family: 'LucideIcons';
        src: url(https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.ttf) format('truetype');
      }
      .lucide {
        font-family: 'LucideIcons';
        font-size: 1.25rem;
        line-height: 1;
        display: inline-block;
        vertical-align: middle;
      }
      body {
          font-family: 'Inter', sans-serif;
          -webkit-text-size-adjust: 100%;
      }
      .search-icon {
          position: absolute;
          top: 50%;
          left: 0.75rem;
          transform: translateY(-50%);
          pointer-events: none;
      }
      .type-management-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.25rem 0;
      }
      .message-box {
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          padding: 10px 20px;
          border-radius: 5px;
          z-index: 1000;
          font-size: 0.9rem;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          opacity: 1;
          transition: opacity 0.5s ease-out;
          max-width: 90%;
          word-break: break-word;
      }
      .message-box.success {
          background-color: #d1e7dd;
          color: #0f5132;
          border: 1px solid #badbcc;
      }
      .message-box.error {
          background-color: #f8d7da;
          color: #842029;
          border: 1px solid #f5c2c7;
      }
      .message-box.hidden {
          opacity: 0;
          pointer-events: none;
      }
      .tab-content {
          display: none;
      }
      .tab-content.active {
          display: block;
      }
      .tab-button {
          padding: 0.5rem 1rem;
          border: 1px solid #e5e7eb;
          background-color: #f9fafb;
          color: #6b7280;
          cursor: pointer;
          transition: all 0.2s;
      }
      .tab-button.active {
          background-color: #ffffff;
          color: #374151;
          border-bottom: 2px solid #4f46e5;
      }
      @media (max-width: 640px) {
          .table-responsive {
              display: block;
              width: 100%;
              overflow-x: auto;
              -webkit-overflow-scrolling: touch;
          }
          .table-responsive table {
              min-width: 600px;
          }
          .mobile-hidden {
              display: none;
          }
          .mobile-full-width {
              width: 100%;
          }
          .mobile-padding {
              padding: 0.5rem;
          }
          .mobile-text-sm {
              font-size: 0.875rem;
          }
          .mobile-flex-col {
              flex-direction: column;
          }
          .mobile-gap-2 {
              gap: 0.5rem;
          }
      }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-100 p-4 md:p-8 font-sans">
    <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-md">
        <h1 class="text-2xl md:text-3xl font-bold mb-6 text-center text-gray-800">Event Management</h1>

        <div id="message-container"></div>

        <div class="mb-6 flex border-b">
            <button class="tab-button active" data-tab="list">조회</button>
            <button class="tab-button" data-tab="register">등록</button>
            <button class="tab-button" data-tab="manage">관리</button>
        </div>

        <div id="list-tab" class="tab-content active">
            <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="search-type" class="block text-sm font-medium text-gray-700 mb-1">구분으로 검색</label>
                    <select id="search-type" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        <option value="">전체</option>
                    </select>
                </div>
                <div>
                    <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">이름으로 검색</label>
                    <div class="relative rounded-md shadow-sm">
                        <span class="lucide text-gray-400 search-icon">&#xE44B;</span> <input type="search" id="search-input" placeholder="검색할 이름 입력..." class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-md">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">번호</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">대상자</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">금액</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">구분</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">메모</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <button onclick="confirmDeleteAll()" class="text-red-600 hover:text-red-900 p-1" title="전체 삭제">
                                    <span class="lucide">&#xE4CF;</span> 전체 삭제
                                </button>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="event-list" class="bg-white divide-y divide-gray-200">
                        <tr id="empty-row" class="hidden">
                            <td colspan="6" class="px-4 py-4 text-center text-sm text-gray-500">등록된 내역이 없거나 검색 결과가 없습니다.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="register-tab" class="tab-content">
            <form id="event-form" class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-8">
                <div class="mobile-full-width">
                    <label for="event-date" class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                    <input type="date" id="event-date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mobile-full-width">
                    <label for="event-type" class="block text-sm font-medium text-gray-700 mb-1">구분</label>
                    <select id="event-type" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white" required>
                        <option value="">구분 선택</option>
                    </select>
                </div>
                <div class="mobile-full-width">
                    <label for="event-person" class="block text-sm font-medium text-gray-700 mb-1">대상자</label>
                    <input type="text" id="event-person" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mobile-full-width">
                    <label for="event-amount" class="block text-sm font-medium text-gray-700 mb-1">금액</label>
                    <input type="number" id="event-amount" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mobile-full-width md:col-span-2">
                    <label for="event-memo" class="block text-sm font-medium text-gray-700 mb-1">메모</label>
                    <textarea id="event-memo" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="mobile-full-width md:col-span-2">
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        등록
                    </button>
                </div>
            </form>
        </div>

        <div id="manage-tab" class="tab-content">
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">구분 관리</h2>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="new-type" placeholder="새 구분 입력" class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="add-type" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        추가
                    </button>
                </div>
                <ul id="type-list" class="space-y-2">
                    <!-- 구분 목록이 여기에 표시됩니다 -->
                    <li id="empty-type-item" class="text-sm text-gray-500 hidden">등록된 구분이 없습니다.</li>
                </ul>
            </div>

            <div class="border-t border-gray-200 pt-8">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">데이터 관리</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-md font-medium mb-2 text-gray-700">엑셀 파일</h3>
                        <p class="text-sm text-gray-600 mb-2">
                            엑셀 파일(.xlsx, .xls)의 첫 번째 시트 데이터를 가져옵니다.<br>
                            필수 헤더: <code class="text-xs bg-gray-200 px-1 rounded">날짜</code>, <code class="text-xs bg-gray-200 px-1 rounded">구분</code>, <code class="text-xs bg-gray-200 px-1 rounded">대상자</code><br>
                            선택 헤더: <code class="text-xs bg-gray-200 px-1 rounded">금액</code>, <code class="text-xs bg-gray-200 px-1 rounded">메모</code>
                        </p>
                        <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                    </div>
                    <div>
                        <h3 class="text-md font-medium mb-2 text-gray-700">JSON 파일</h3>
                        <div class="space-y-2">
                            <button onclick="exportToJSON()" class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <span class="lucide mr-2">&#xE2C4;</span> JSON Export
                            </button>
                            <div class="relative">
                                <input type="file" id="json-file-input" accept=".json" class="hidden" />
                                <button onclick="document.getElementById('json-file-input').click()" class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    <span class="lucide mr-2">&#xE2C5;</span> JSON Import
                                </button>
                            </div>
                            <button onclick="downloadJSON()" class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <span class="lucide mr-2">&#xE2C4;</span> JSON Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const eventForm = document.getElementById('event-form');
        const eventList = document.getElementById('event-list');
        const emptyRow = document.getElementById('empty-row');
        const searchInput = document.getElementById('search-input');
        const searchType = document.getElementById('search-type');
        const eventTypeSelect = document.getElementById('event-type');
        const typeListUl = document.getElementById('type-list');
        const newTypeInput = document.getElementById('new-type');
        const addTypeButton = document.getElementById('add-type');
        const emptyTypeItem = document.getElementById('empty-type-item');
        const excelFileInput = document.getElementById('excel-file-input');
        const messageContainer = document.getElementById('message-container');

        // --- Constants ---
        const EVENTS_STORAGE_KEY = 'gyeongjosaEvents';
        const TYPES_STORAGE_KEY = 'gyeongjosaTypes';
        const DEFAULT_TYPES = ['결혼', '할머니 장례'];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTypes();
            loadEvents();
            searchInput.addEventListener('input', loadEvents);
            searchType.addEventListener('change', loadEvents);
            addTypeButton.addEventListener('click', handleAddType);
            newTypeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAddType();
                }
            });
            eventForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newEvent = {
                    id: Date.now(),
                    date: document.getElementById('event-date').value,
                    type: document.getElementById('event-type').value,
                    person: document.getElementById('event-person').value.trim(),
                    amount: document.getElementById('event-amount').value,
                    notes: document.getElementById('event-memo').value.trim(),
                };

                if (!newEvent.date || !newEvent.type || !newEvent.person) {
                    showMessage('날짜, 구분, 대상자는 필수 항목입니다.', 'error');
                    return;
                }

                saveSingleEvent(newEvent);
                loadEvents();
                eventForm.reset();
                if (eventTypeSelect.options.length > 0) {
                    eventTypeSelect.selectedIndex = 0;
                }
                showMessage('새로운 내역이 추가되었습니다.', 'success');
            });
            excelFileInput.addEventListener('change', handleExcelFile);

            // 탭 기능 초기화
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.getAttribute('data-tab');
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(`${tab}-tab`).classList.add('active');
                });
            });
        });

        // --- Message Display Function ---
        function showMessage(text, type = 'success') {
            const messageBox = document.createElement('div');
            messageBox.textContent = text;
            messageBox.className = `message-box ${type}`;
            while (messageContainer.firstChild) {
                messageContainer.removeChild(messageContainer.firstChild);
            }
            messageContainer.appendChild(messageBox);
            setTimeout(() => {
                messageBox.classList.add('hidden');
                setTimeout(() => messageBox.remove(), 500);
            }, 3000);
        }

        // --- Type Management Functions ---
        function getTypesFromStorage() {
            const typesJson = localStorage.getItem(TYPES_STORAGE_KEY);
            let types = typesJson ? JSON.parse(typesJson) : [...DEFAULT_TYPES];
            if (!Array.isArray(types)) {
                types = [...DEFAULT_TYPES];
                localStorage.setItem(TYPES_STORAGE_KEY, JSON.stringify(types));
            }
            return types;
        }

        function saveTypesToStorage(types) {
            localStorage.setItem(TYPES_STORAGE_KEY, JSON.stringify(types));
        }

        function loadTypes() {
            const types = getTypesFromStorage();
            populateTypeDropdown(types);
            populateTypeManagementList(types);
            populateSearchTypeDropdown(types);
        }

        function populateTypeDropdown(types) {
            eventTypeSelect.innerHTML = '';
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                eventTypeSelect.appendChild(option);
            });
        }

        function populateTypeManagementList(types) {
            typeListUl.innerHTML = '';
            if (types.length === 0) {
                emptyTypeItem.classList.remove('hidden');
            } else {
                emptyTypeItem.classList.add('hidden');
                types.forEach(type => {
                    const li = document.createElement('li');
                    li.className = 'type-management-item text-sm';
                    li.innerHTML = `
                        <span>${escapeHtml(type)}</span>
                        <button onclick="handleDeleteType('${escapeHtml(type)}')" class="text-red-500 hover:text-red-700 p-1" title="삭제">
                            <span class="lucide text-sm">&#xE4CF;</span> </button>
                    `;
                    typeListUl.appendChild(li);
                });
            }
        }

        function populateSearchTypeDropdown(types) {
            searchType.innerHTML = '<option value="">전체</option>';
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                searchType.appendChild(option);
            });
        }

        function handleAddType() {
            const newTypeName = newTypeInput.value.trim();
            if (newTypeName) {
                let types = getTypesFromStorage();
                if (!types.includes(newTypeName)) {
                    types.push(newTypeName);
                    saveTypesToStorage(types);
                    loadTypes();
                    newTypeInput.value = '';
                    showMessage(`'${newTypeName}' 구분이 추가되었습니다.`, 'success');
                } else {
                    showMessage(`'${newTypeName}' 구분은 이미 존재합니다.`, 'error');
                }
            } else {
                 showMessage('추가할 구분 이름을 입력하세요.', 'error');
            }
        }

        window.handleDeleteType = function(typeToDelete) {
            if (confirm(`'${typeToDelete}' 구분을 삭제하시겠습니까? 이 구분을 사용한 기존 내역에는 영향을 주지 않습니다.`)) {
                let types = getTypesFromStorage();
                types = types.filter(type => type !== typeToDelete);
                saveTypesToStorage(types);
                loadTypes();
                showMessage(`'${typeToDelete}' 구분이 삭제되었습니다.`, 'success');
            }
        }

        // --- Event Management Functions ---
        function getEventsFromStorage() {
            const eventsJson = localStorage.getItem(EVENTS_STORAGE_KEY);
            try {
                return eventsJson ? JSON.parse(eventsJson) : [];
            } catch (e) {
                console.error("Error parsing events from localStorage:", e);
                localStorage.removeItem(EVENTS_STORAGE_KEY);
                showMessage('데이터 로딩 중 오류가 발생했습니다. 데이터를 초기화합니다.', 'error');
                return [];
            }
        }

        function saveEventsToStorage(events) {
            localStorage.setItem(EVENTS_STORAGE_KEY, JSON.stringify(events));
        }

        function saveSingleEvent(event) {
            const events = getEventsFromStorage();
            events.push(event);
            saveEventsToStorage(events);
        }

        function loadEvents() {
            const allEvents = getEventsFromStorage();
            const searchTerm = searchInput.value.trim().toLowerCase();
            const selectedType = searchType.value;
            
            const filteredEvents = allEvents.filter(event => {
                const personName = event.person || '';
                const typeMatch = !selectedType || event.type === selectedType;
                const nameMatch = !searchTerm || personName.toLowerCase().includes(searchTerm);
                return typeMatch && nameMatch;
            });
            
            eventList.innerHTML = '';
            if (filteredEvents.length === 0) {
                showEmptyRow();
            } else {
                hideEmptyRow();
                filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
                filteredEvents.forEach((event, index) => {
                    addEventToList(event, index + 1);
                });
            }
        }

        function addEventToList(event, rowNumber) {
             const row = document.createElement('tr');
             row.setAttribute('data-id', event.id);
             row.classList.add('hover:bg-gray-50');

             const formattedAmount = event.amount && !isNaN(parseInt(event.amount, 10))
                                    ? parseInt(event.amount, 10).toLocaleString('ko-KR') + '만원'
                                    : '-';

             row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${rowNumber}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${escapeHtml(event.person || '-')}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formattedAmount}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${escapeHtml(event.type || '-')}</td>
                <td class="px-4 py-3 text-sm text-gray-700 break-words max-w-xs">${escapeHtml(event.notes || '-')}</td>
                <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                    <button onclick="confirmDelete(${event.id})" class="text-red-600 hover:text-red-900 p-1" title="삭제">
                        <span class="lucide">&#xE4CF;</span> </button>
                </td>
            `;
            eventList.appendChild(row);
        }

        window.confirmDeleteAll = function() {
            if (confirm('모든 내역을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                deleteAllEvents();
            }
        }

        function deleteAllEvents() {
            localStorage.removeItem(EVENTS_STORAGE_KEY);
            loadEvents();
            showMessage('모든 내역이 삭제되었습니다.', 'success');
        }

        window.confirmDelete = function(id) {
            if (confirm('이 항목을 삭제하시겠습니까? 삭제하면 복구할 수 없습니다.')) {
                deleteEvent(id);
            }
        }

        function deleteEvent(id) {
            let events = getEventsFromStorage();
            const initialLength = events.length;
            events = events.filter(event => event.id !== id);
            if (events.length < initialLength) {
                saveEventsToStorage(events);
                loadEvents();
                showMessage('선택한 내역이 삭제되었습니다.', 'success');
            } else {
                 showMessage('삭제할 항목을 찾지 못했습니다.', 'error');
            }
        }

        function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) { return; }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) {
                         showMessage('엑셀 파일에 헤더 또는 데이터가 없습니다.', 'error');
                        return;
                    }

                    const headers = jsonData[0].map(h => String(h).trim());
                    const requiredHeaders = ['날짜', '구분', '대상자'];
                    const missingHeaders = requiredHeaders.filter(rh => !headers.includes(rh));

                    if (missingHeaders.length > 0) {
                        showMessage(`엑셀 파일에 필수 헤더가 누락되었습니다: ${missingHeaders.join(', ')}`, 'error');
                        return;
                    }

                    const headerMap = {};
                    headers.forEach((h, index) => { headerMap[h] = index; });

                    let addedCount = 0;
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row[headerMap['날짜']] && row[headerMap['구분']] && row[headerMap['대상자']]) {
                            let excelDate = row[headerMap['날짜']];
                            let formattedDate = '';
                            if (excelDate instanceof Date) {
                                const year = excelDate.getFullYear();
                                const month = String(excelDate.getMonth() + 1 ).padStart(2, '0');
                                const day = String(excelDate.getDate()).padStart(2, '0');
                                formattedDate = `${year}-${month}-${day}`;
                            } else if (typeof excelDate === 'number') {
                                const dateObj = XLSX.SSF.parse_date_code(excelDate);
                                if (dateObj) {
                                     const year = dateObj.y;
                                     const month = String(dateObj.m).padStart(2, '0');
                                     const day = String(dateObj.d).padStart(2, '0');
                                     formattedDate = `${year}-${month}-${day}`;
                                }
                            } else if (typeof excelDate === 'string') {
                                formattedDate = excelDate;
                            }

                            const newEvent = {
                                id: Date.now() + i,
                                date: formattedDate,
                                type: String(row[headerMap['구분']] || '').trim(),
                                person: String(row[headerMap['대상자']] || '').trim(),
                                amount: String(row[headerMap['금액']] || '').trim(),
                                notes: String(row[headerMap['메모']] || '').trim(),
                            };
                            saveSingleEvent(newEvent);
                            addedCount++;
                        } else {
                             console.warn(`Skipping row ${i + 1}: Missing required data (날짜, 구분, 대상자).`);
                        }
                    }
                    loadEvents();
                    showMessage(`${addedCount}개의 내역을 엑셀 파일에서 가져왔습니다.`, 'success');
                } catch (error) {
                    console.error("Error processing Excel file:", error);
                    showMessage('엑셀 파일을 처리하는 중 오류가 발생했습니다. 파일 형식이나 내용을 확인하세요.', 'error');
                } finally {
                     excelFileInput.value = '';
                }
            };
            reader.onerror = (error) => {
                 console.error("File reading error:", error);
                 showMessage('파일을 읽는 중 오류가 발생했습니다.', 'error');
                 excelFileInput.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        function showEmptyRow() {
            const searchTerm = searchInput.value.trim();
            emptyRow.querySelector('td').setAttribute('colspan', '6');
            emptyRow.querySelector('td').textContent = searchTerm
                ? `"${escapeHtml(searchTerm)}"에 대한 검색 결과가 없습니다.`
                : '등록된 내역이 없습니다.';
            emptyRow.classList.remove('hidden');
        }

        function hideEmptyRow() {
             emptyRow.classList.add('hidden');
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // --- Export Functions ---
        function exportToJSON() {
            const events = getEventsFromStorage();
            if (events.length === 0) {
                showMessage('저장할 내역이 없습니다.', 'error');
                return;
            }

            const jsonData = {
                events: events,
                lastUpdated: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `경조사_내역_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage('JSON 파일이 저장되었습니다.', 'success');
        }

        function loadJSON() {
            fetch('./data/list.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('파일을 불러오는데 실패했습니다.');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.events && Array.isArray(data.events)) {
                        saveEventsToStorage(data.events);
                        loadEvents();
                        showMessage(`${data.events.length}개의 내역을 JSON 파일에서 가져왔습니다.`, 'success');
                    } else {
                        throw new Error('잘못된 JSON 형식입니다.');
                    }
                })
                .catch(error => {
                    console.error('Error loading JSON:', error);
                    showMessage(error.message, 'error');
                });
        }

        // JSON 파일 로드 이벤트 리스너 추가
        document.getElementById('json-file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.events && Array.isArray(data.events)) {
                        saveEventsToStorage(data.events);
                        loadEvents();
                        showMessage(`${data.events.length}개의 내역을 JSON 파일에서 가져왔습니다.`, 'success');
                    } else {
                        throw new Error('잘못된 JSON 형식입니다.');
                    }
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    showMessage('JSON 파일 형식이 올바르지 않습니다.', 'error');
                }
            };
            reader.onerror = function(error) {
                console.error('File reading error:', error);
                showMessage('파일을 읽는 중 오류가 발생했습니다.', 'error');
            };
            reader.readAsText(file);
        });

        function downloadJSON() {
            fetch('./data/list.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('파일을 다운로드하는데 실패했습니다.');
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'list.json';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showMessage('JSON 파일이 다운로드되었습니다.', 'success');
                })
                .catch(error => {
                    console.error('Error downloading JSON:', error);
                    showMessage(error.message, 'error');
                });
        }
    </script>
</body>
</html>
